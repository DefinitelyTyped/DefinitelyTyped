name: Update support window diagram
on:
  # When our dependencies change
  push:
    paths:
      - .github/workflows/support-window.yml
      - package.json
      - scripts/support-window.ts
      - scripts/tsconfig.json
  # At the end of the next support window
  schedule:
    - cron: 13 21 12 5 *
  # Manually, when TypeScript is released
  # https://docs.github.com/en/actions/managing-workflow-runs/manually-running-a-workflow
  workflow_dispatch:
jobs:
  support-window:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          token: ${{ github.repository == 'DefinitelyTyped/DefinitelyTyped' && secrets.GH_TOKEN || github.token }}
      - uses: actions/setup-node@v2
        #with:
        #  cache: npm
      - run: npm install
      - run: tsc --build scripts
      - name: Fetch TypeScript versions and release dates from npm
        run: |
          npm view --json typescript time |
          jq '
            to_entries
            # Earliest non-pre-release <major>.<minor>
            | map(
              (.key |= capture("^(?<version>[0-9]+\\.[0-9]+)\\.[0-9]+$").version)
              | select(.key)
            )
            | unique_by(.key)
            | from_entries
          ' > docs/support-window.json
      - name: Make SVG diagram
        run: node --experimental-json-modules scripts/support-window > docs/support-window.svg
      - if: github.repository == 'DefinitelyTyped/DefinitelyTyped'
        name: Schedule update at the end of the next support window
        run: |
          sed --in-place "0,/cron: .*/s//cron: $(
            jq --raw-output '
              first(
                .[]
                # https://github.com/stedolan/jq/issues/1409
                # https://www.ietf.org/rfc/rfc3339.html#section-5.6
                | capture("^(?<fullyear>[0-9]{4})-(?<month>[0-9]{2})-(?<mday>[0-9]{2})T(?<hour>[0-9]{2}):(?<minute>[0-9]{2}):(?<second>[0-9]{2})(?<secfrac>\\.[0-9]+)?Z$")
                | map_values(tonumber)
                | select(
                  # The number of months since January, in the range 0 to 11
                  [.fullyear + 2, .month - 1, .mday, .hour, .minute, .second + .secfrac, 0, 0]
                  | mktime > now
                )
              )
              | "\(.minute) \(.hour) \(.mday) \(.month) *"
            ' docs/support-window.json
          )/" .github/workflows/support-window.yml
      - run: git add .
      - run: git config user.name .github/workflows/support-window.yml
      - run: git config user.email bot@typescriptlang.org
      - run: |
          git diff --quiet --cached ||
          git commit \
            --message "[README] ðŸ¤– Update support window diagram" \
            --message "$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" \
      - run: git push
