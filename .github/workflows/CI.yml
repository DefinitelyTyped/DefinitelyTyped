name: CI
on: pull_request

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: "12"

      # Get local dependencies
      #- run: npm install

      # Run tests
      - run: |
          git clone https://github.com/microsoft/DefinitelyTyped-tools.git
          patch --directory DefinitelyTyped-tools --strip 1 <<'patchfile'
          --- a/packages/definitions-parser/src/lib/definition-parser.ts
          +++ b/packages/definitions-parser/src/lib/definition-parser.ts
          @@ -279,12 +279,9 @@ function getTypingDataForSingleTypesVersion(
               types.set(untestedTypeFile, createSourceFile(untestedTypeFile, fs.readFile(untestedTypeFile)));
             }
           
          -  const { dependencies: dependenciesWithDeclaredModules, globals, declaredModules } = getModuleInfo(packageName, types);
          -  const declaredModulesSet = new Set(declaredModules);
          -  // Don't count an import of "x" as a dependency if we saw `declare module "x"` somewhere.
          -  const dependenciesSet = new Set(filter(dependenciesWithDeclaredModules, m => !declaredModulesSet.has(m)));
          +  const { dependencies: dependenciesSet, globals, declaredModules } = getModuleInfo(packageName, types);
             const testDependencies = Array.from(
          -    filter(getTestDependencies(packageName, types, tests.keys(), dependenciesSet, fs), m => !declaredModulesSet.has(m))
          +    getTestDependencies(packageName, types, tests.keys(), dependenciesSet, fs)
             );
           
             const { dependencies, pathMappings } = calculateDependencies(
          patchfile
          #curl https://patch-diff.githubusercontent.com/raw/microsoft/DefinitelyTyped-tools/pull/98.patch | patch --directory DefinitelyTyped-tools --strip 1
          git clone https://github.com/microsoft/dtslint.git
          curl https://patch-diff.githubusercontent.com/raw/microsoft/dtslint/pull/308.patch | patch --directory dtslint --strip 1
          yarn --cwd dtslint link
          yarn --cwd dtslint link dtslint
          yarn --cwd DefinitelyTyped-tools link dtslint
          yarn --cwd DefinitelyTyped-tools
          tsc --build DefinitelyTyped-tools/packages/dtslint-runner
          yarn --cwd dtslint
          yarn --cwd dtslint build
          node DefinitelyTyped-tools/packages/dtslint-runner/dist/index.js --path .

      - name: "Run Danger"
        env:
          # See https://github.com/danger/danger-js/issues/1042
          DANGER_GITHUB_API_BASE_URL: "https://api.github.com"

        # Danger failing (for example through rate-limiting) shouldn't fail the build
        run: |
          TOKEN='7469b4e94ce21b43e3ab7a'
          TOKEN+='79960c12a1e067f2ec'
          DANGER_GITHUB_API_TOKEN=$TOKEN yarn danger ci || $( exit 0 )
